<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Vue Kanban pour work.program -->
    <record id="view_work_program_kanban" model="ir.ui.view">
        <field name="name">work.program.kanban</field>
        <field name="model">work.program</field>
        <field name="arch" type="xml">
            <kanban default_group_by="state" class="o_kanban_small_column" quick_create="false">
                <!-- Champs utilisés dans la vue -->
                <field name="id"/>
                <field name="state"/>
                <field name="name"/>
                <field name="user_id"/>
                <field name="responsible_id"/>
                <field name="project_id"/>
                <field name="activity_id"/>
                <field name="priority"/>
                <field name="complexity"/>
                <field name="completion_percentage"/>
                <field name="initial_deadline"/>
                <field name="actual_deadline"/>
                <field name="my_month"/>
                <field name="my_week_of"/>
                <field name="duration_effort"/>
                <field name="deliverable_ids"/>
                <field name="support_ids"/>
                <field name="work_programm_department_id"/>

                <!-- Progressbar pour le suivi visuel -->
                <progressbar field="state" colors='{"draft": "muted", "ongoing": "info", "to_validate": "warning", "validated": "success", "done": "success", "refused": "danger", "cancelled": "danger", "to_redo": "info", "incomplete": "warning"}'/>

                <!-- Templates -->
                <templates>
                    <t t-name="kanban-box">
                        <div class="oe_kanban_global_click">
                            <!-- En-tête de la carte -->
                            <div class="o_kanban_record_top">
                                <div class="o_kanban_record_headings">
                                    <strong class="o_kanban_record_title">
                                        <field name="name"/>
                                    </strong>
                                    <br/>
                                    <span class="text-muted">
                                        <field name="project_id"/>
                                    </span>
                                </div>
                                <div class="o_kanban_record_top_right">
                                    <!-- Badge de priorité -->
                                    <field name="priority" widget="priority"/>
                                </div>
                            </div>

                            <!-- Corps de la carte -->
                            <div class="o_kanban_record_body">
                                <div class="row">
                                    <div class="col-12">
                                        <t t-if="record.activity_id.raw_value">
                                            <i class="fa fa-tasks"/>
                                            <field name="activity_id"/>
                                        </t>
                                    </div>
                                </div>

                                <div class="row mt-2">
                                    <div class="col-6">
                                        <span class="badge badge-pill badge-info" t-if="record.complexity.raw_value">
                                            <i class="fa fa-signal"/>
                                            <field name="complexity"/>
                                        </span>
                                    </div>
                                    <div class="col-6 text-right">
                                        <span class="badge badge-pill badge-secondary" t-if="record.duration_effort.raw_value">
                                            <i class="fa fa-clock-o"/>
                                            <field name="duration_effort"/>h
                                        </span>
                                    </div>
                                </div>

                                <!-- Barre de progression -->
                                <div class="row mt-2" t-if="record.completion_percentage.raw_value">
                                    <div class="col-12">
                                        <div class="progress" style="height: 8px;">
                                            <div class="progress-bar"
                                                 role="progressbar"
                                                 t-att-style="'width: ' + record.completion_percentage.raw_value + '%'"
                                                 t-attf-class="progress-bar #{record.completion_percentage.raw_value &lt; 30 ? 'bg-danger' : (record.completion_percentage.raw_value &lt; 70 ? 'bg-warning' : 'bg-success')}">
                                            </div>
                                        </div>
                                        <small class="text-muted">
                                            <field name="completion_percentage"/>% complété
                                        </small>
                                    </div>
                                </div>

                                <!-- Livrables -->
                                <div class="row mt-2" t-if="record.deliverable_ids.raw_value.length">
                                    <div class="col-12">
                                        <field name="deliverable_ids" widget="many2many_tags"/>
                                    </div>
                                </div>

                                <!-- Période -->
                                <div class="row mt-2">
                                    <div class="col-12">
                                        <small class="text-muted">
                                            <i class="fa fa-calendar"/>
                                            <field name="my_month"/> -
                                            <field name="my_week_of"/>
                                        </small>
                                    </div>
                                </div>
                            </div>

                            <!-- Pied de la carte -->
                            <div class="o_kanban_record_bottom">
                                <div class="oe_kanban_bottom_left">
                                    <!-- Date limite avec code couleur -->
                                    <t t-if="record.actual_deadline.raw_value or record.initial_deadline.raw_value">
                                        <span t-attf-class="badge #{(record.actual_deadline.raw_value || record.initial_deadline.raw_value) &lt; new Date().toISOString().split('T')[0] ? 'badge-danger' : 'badge-secondary'}">
                                            <i class="fa fa-calendar-check-o"/>
                                            <field name="actual_deadline" t-if="record.actual_deadline.raw_value"/>
                                            <field name="initial_deadline" t-else=""/>
                                        </span>
                                    </t>
                                </div>
                                <div class="oe_kanban_bottom_right">
                                    <!-- Avatar du responsable -->
                                    <t t-if="record.responsible_id.raw_value">
                                        <img t-att-src="kanban_image('hr.employee', 'image_128', record.responsible_id.raw_value)"
                                             class="oe_kanban_avatar"
                                             alt="Responsable"
                                             width="24"
                                             height="24"/>
                                    </t>

                                    <!-- Support (membres de l'équipe) -->
                                    <t t-if="record.support_ids.raw_value.length">
                                        <span class="badge badge-secondary ml-1">
                                            <i class="fa fa-users"/>
                                            <t t-esc="record.support_ids.raw_value.length"/>
                                        </span>
                                    </t>
                                </div>
                            </div>

                            <!-- Dropdown menu -->
                            <div class="o_dropdown_kanban dropdown">
                                <a class="dropdown-toggle o-no-caret btn" role="button" data-toggle="dropdown" href="#" aria-label="Dropdown menu" title="Dropdown menu">
                                    <span class="fa fa-ellipsis-v"/>
                                </a>
                                <div class="dropdown-menu" role="menu">
                                    <a role="menuitem" type="edit" class="dropdown-item">Modifier</a>
                                    <a role="menuitem" type="delete" class="dropdown-item">Supprimer</a>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- Vue Kanban groupée par responsable (alternative) -->
    <record id="view_work_program_kanban_by_responsible" model="ir.ui.view">
        <field name="name">work.program.kanban.by.responsible</field>
        <field name="model">work.program</field>
        <field name="arch" type="xml">
            <kanban default_group_by="responsible_id" class="o_kanban_small_column" quick_create="false">
                <field name="id"/>
                <field name="state"/>
                <field name="name"/>
                <field name="responsible_id"/>
                <field name="project_id"/>
                <field name="priority"/>
                <field name="completion_percentage"/>
                <field name="initial_deadline"/>

                <templates>
                    <t t-name="kanban-box">
                        <div class="oe_kanban_global_click">
                            <div class="o_kanban_record_top">
                                <div class="o_kanban_record_headings">
                                    <strong class="o_kanban_record_title">
                                        <field name="name"/>
                                    </strong>
                                </div>
                                <div class="o_kanban_record_top_right">
                                    <field name="priority" widget="priority"/>
                                </div>
                            </div>

                            <div class="o_kanban_record_body">
                                <field name="project_id"/>
                                <div class="mt-2">
                                    <span t-attf-class="badge badge-pill #{record.state.raw_value === 'done' ? 'badge-success' : (record.state.raw_value === 'ongoing' ? 'badge-info' : 'badge-secondary')}">
                                        <field name="state"/>
                                    </span>
                                </div>
                                <div class="mt-2" t-if="record.completion_percentage.raw_value">
                                    <small><field name="completion_percentage"/>% complété</small>
                                </div>
                            </div>

                            <div class="o_kanban_record_bottom">
                                <div class="oe_kanban_bottom_left">
                                    <field name="initial_deadline" widget="date"/>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

</odoo>